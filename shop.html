<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean Horizon | Shop</title>
      <link rel="stylesheet" href="css/index.css">
      <link rel="stylesheet" href="css/shop.css">
    <link rel="icon" type="image/png" href="img/Ocean_Horizon_Website_Icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
         <div class="bubbles">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
  </div>
     <header>
       <a href="index.html"><img src="img/Ocean_Horizon_Website_Icon.png" alt="Ocean Horizon Logo" class="logohd"></a> 
       <a href="index.html"> Trang Ch·ªß</a>
              <!-- Dropdown -->
  <div class="dropdown">
    <a href="about.html" class="dropbtn">Gi·ªõi Thi·ªáu</a>
    <div class="dropdown-content">
      <a href="tuyendung.html">Tuy·ªÉn D·ª•ng</a>
    </div>
  </div>
        
<!-- √î t√¨m ki·∫øm -->
<form action="#" method="get" class="search-box" onsubmit="return false;">
  <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s√°ch..." required>
  <button type="button" onclick="searchProducts()">üîç</button>
</form>
  <a href="contact.html">T∆∞ V·∫•n</a>
     <a href="shop.html" class="cart-link">
  Gi·ªè h√†ng <span id="cart-count">0</span>
</a>

       <a href="login.html" id="loginLink">ƒêƒÉng nh·∫≠p</a>

    </header>


  <h1>Gi·ªè H√†ng</h1>
<table class="cart-table" id="cartTable">
  <thead>
    <tr>
      <th>S·∫£n ph·∫©m</th>
      <th>Gi√°</th>
      <th>S·ªë l∆∞·ª£ng</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody id="cartBody">
    <!-- Render s·∫£n ph·∫©m -->
  </tbody>
</table>

<!-- Gom T·ªïng + N√∫t Thanh To√°n v√†o chung -->
<div class="cart-footer">
  <div class="total" id="cart-total">T·ªïng: 0ƒë</div>
  <button id="checkoutBtn">Thanh To√°n</button>
</div>

<div class="empty-cart" id="emptyCartMsg" style="display:none;">
  Gi·ªè h√†ng tr·ªëng!
</div>


<!-- Popup thanh to√°n -->
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Thanh To√°n</h2>
    <p id="modalTotal">T·ªïng: 0ƒë</p>
    <button id="downloadBill">T·∫£i H√≥a ƒê∆°n</button>
    <div class="qr-container">
      <p>Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n:</p>
      <img src="img/BankQR.jpg" alt="QR Bank" class="qr-code">
    </div>
  </div>



 <script>
/* Helper: parse price string -> integer (ƒë·ªìng) */
function parsePrice(val) {
  if (val == null) return 0;
  if (typeof val === "number" && !isNaN(val)) return Math.trunc(val);
  const digits = val.toString().replace(/[^\d]/g, "");
  return digits ? parseInt(digits, 10) : 0;
}
function formatPrice(n) {
  return n.toLocaleString("vi-VN") + "ƒë";
}

/* L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m t·ª´ sections (fallback sang products) */
function getAllProducts() {
  const sections = JSON.parse(localStorage.getItem("sections")) || {};
  let all = Object.values(sections).flat();
  if (!all || all.length === 0) {
    all = JSON.parse(localStorage.getItem("products")) || [];
  }
  return all;
}
function getProductById(id) {
  if (!id) return null;
  return getAllProducts().find(p => p.id === id) || null;
}

/* C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã ·ªü header */
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const count = cart.reduce((s, it) => s + (Number(it.quantity) || 0), 0);
  const el = document.getElementById("cart-count");
  if (el) el.innerText = count;
}

/* Render gi·ªè h√†ng */
function renderCart() {
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const tbody = document.getElementById("cartBody");
  const totalEl = document.getElementById("cart-total");
  const emptyMsg = document.getElementById("emptyCartMsg");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const table = document.querySelector(".cart-table");

  tbody.innerHTML = "";
  let total = 0;

  if (cart.length === 0) {
    if (table) table.style.display = "none";
    if (emptyMsg) emptyMsg.style.display = "block";
    if (totalEl) totalEl.innerText = "T·ªïng: 0ƒë";
    if (checkoutBtn) checkoutBtn.style.display = "none";
    updateCartCount();
    return;
  } else {
    if (table) table.style.display = "table";
    if (emptyMsg) emptyMsg.style.display = "none";
    if (checkoutBtn) checkoutBtn.style.display = "inline-block";
  }

  cart.forEach((item, idx) => {
    const product = getProductById(item.id);
    if (!product) return; // n·∫øu sp b·ªã x√≥a tr√™n admin v·∫´n an to√†n

    const priceNum = parsePrice(product.price);
    const qty = Number(item.quantity) || 1;
    total += priceNum * qty;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${product.name || "S·∫£n ph·∫©m"}</td>
      <td>${formatPrice(priceNum)}</td>
      <td>${qty}</td>
      <td><button class="remove-btn" data-index="${idx}">X√≥a</button></td>
    `;
    tbody.appendChild(tr);
  });

  if (totalEl) totalEl.innerText = `T·ªïng: ${formatPrice(total)}`;

  /* G·∫Øn s·ª± ki·ªán X√ìA theo index (an to√†n) */
  document.querySelectorAll(".remove-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const index = Number(btn.dataset.index);
      if (isNaN(index)) return;
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      updateCartCount();
    });
  });

  updateCartCount();
}

/* Checkout: m·ªü modal v√† hi·ªÉn th·ªã t·ªïng ch√≠nh x√°c (l·∫•y t·ª´ sections) */
document.addEventListener("DOMContentLoaded", () => {
  renderCart();
  updateCartCount();

  const checkoutBtn = document.getElementById("checkoutBtn");
  const modal = document.getElementById("checkoutModal");
  const modalTotal = document.getElementById("modalTotal");
  const closeBtn = modal ? modal.querySelector(".close") : null;
  const downloadBill = document.getElementById("downloadBill");

  if (checkoutBtn) {
    checkoutBtn.addEventListener("click", () => {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      let total = 0;
      cart.forEach(item => {
        const product = getProductById(item.id);
        if (!product) return;
        const priceNum = parsePrice(product.price);
        const qty = Number(item.quantity) || 1;
        total += priceNum * qty;
      });
      if (modalTotal) modalTotal.innerText = `T·ªïng: ${formatPrice(total)}`;
      if (modal) modal.style.display = "flex";
    });
  }

  if (closeBtn) closeBtn.addEventListener("click", () => {
    if (modal) modal.style.display = "none";
  });

  window.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
  });

  /* Download bill: t·∫°o file text v·ªõi t√™n, ƒë∆°n gi√°, qty, line total, t·ªïng */
 if (downloadBill) {
  downloadBill.addEventListener("click", () => {
    const { jsPDF } = window.jspdf; // l·∫•y t·ª´ th∆∞ vi·ªán
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const doc = new jsPDF();

    let y = 20;
    let total = 0;

    // Ti√™u ƒë·ªÅ
    doc.setFontSize(18);
    doc.text("H√ìA ƒê∆†N OCEAN HORIZON", 14, y);
    y += 10;

    doc.setFontSize(12);

    // N·ªôi dung h√≥a ƒë∆°n
    cart.forEach((item, idx) => {
      const product = getProductById(item.id);
      if (!product) return;

      const priceNum = parsePrice(product.price);
      const qty = Number(item.quantity) || 1;
      const lineTotal = priceNum * qty;
      total += lineTotal;

      doc.text(`${idx + 1}. ${product.name} - ${formatPrice(priceNum)} x${qty} = ${formatPrice(lineTotal)}`, 14, y);
      y += 8;
    });

    // T·ªïng c·ªông
    y += 10;
    doc.setFontSize(14);
    doc.text(`T·ªïng: ${formatPrice(total)}`, 14, y);

    // L∆∞u file PDF
    doc.save("hoa_don_OceanHorizon.pdf");
  });
}

});

document.addEventListener("DOMContentLoaded", () => {
  const loginLink = document.getElementById("loginLink");
  const users = JSON.parse(localStorage.getItem("users")) || {};
  const currentUserEmail = localStorage.getItem("currentUser");
if (!loginLink) return; 
  if (currentUserEmail && users[currentUserEmail]) {
    const user = users[currentUserEmail];

    // T·∫°o menu user
    const userMenu = document.createElement("div");
    userMenu.classList.add("user-menu");
    userMenu.innerHTML = `
      <span class="username"> ${user.name}</span>
      <div class="dropdown-user">
        <a href="#" id="profileBtn">H·ªì s∆°</a>
        <a href="#" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
      </div>
    `;

    // Thay n√∫t ƒëƒÉng nh·∫≠p b·∫±ng user menu
    loginLink.replaceWith(userMenu);

    // Toggle dropdown
    const usernameSpan = userMenu.querySelector(".username");
    const dropdown = userMenu.querySelector(".dropdown-user");
    usernameSpan.addEventListener("click", () => {
      dropdown.classList.toggle("show");
    });

    // Popup h·ªì s∆°
    const profilePopup = document.createElement("div");
    profilePopup.classList.add("profile-popup");
    profilePopup.innerHTML = `
      <div class="popup-content">
        <img src="${user.avatar || "img/default-avatar.png"}" alt="Avatar">
        <h3>${user.name}</h3>
        <p>Email: ${currentUserEmail}</p>
        <button id="closeProfile">ƒê√≥ng</button>
      </div>
    `;
    document.body.appendChild(profilePopup);

    // M·ªü popup
    document.getElementById("profileBtn").addEventListener("click", (e) => {
      e.preventDefault();
      profilePopup.style.display = "flex";
    });

    // ƒê√≥ng popup
    profilePopup.querySelector("#closeProfile").addEventListener("click", () => {
      profilePopup.style.display = "none";
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("currentUser");
      window.location.reload();
    });
  }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>